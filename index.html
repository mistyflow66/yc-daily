<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sodagreen Dashboard (Secure)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&display=swap');
        :root {
            --bg: #0E0B14; --surface: #181225;
            --primary: #7B3DFF; --secondary: #FF6A3D;
            --accent-yellow: #FFC247; --accent-green: #2BCB7D;
            --accent-pink: #E5A3C7; --accent-blue: #3D57FF;
            --text: #F3F0FF; --text-muted: #B8AFCF;
        }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; }
        .font-serif-tc { font-family: 'Noto Serif TC', serif; }
        .surface { background-color: var(--surface); border: 1px solid rgba(255,255,255,0.05); }
        .done-text { text-decoration: line-through; color: var(--text-muted); opacity: 0.5; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    </style>
</head>
<body class="p-4 pb-10">

    <div class="max-w-md mx-auto space-y-6">
        <header class="flex justify-between items-center py-2">
            <h1 class="text-2xl font-black tracking-tighter" style="color: var(--primary)">DASHBOARD.exe</h1>
            <div class="flex gap-2">
                <button onclick="resetToken()" class="text-[9px] opacity-30 hover:opacity-100 border border-white/20 px-2 py-0.5 rounded">RESET KEY</button>
                <div id="status" class="text-[10px] uppercase tracking-widest px-2 py-1 rounded bg-white/5 text-muted">Initializing...</div>
            </div>
        </header>

        <section class="surface rounded-3xl p-6 shadow-2xl relative overflow-hidden min-h-[140px] flex flex-col justify-center">
            <div id="lyric-content" class="relative z-10"></div>
            <div id="video-container" class="hidden mt-4 overflow-hidden rounded-xl bg-black aspect-video relative z-10"></div>
            <div class="absolute -top-10 -right-10 w-32 h-32 blur-[80px]" style="background: var(--primary); opacity: 0.2;"></div>
        </section>

        <div class="surface p-5 rounded-3xl shadow-xl">
            <input id="mainInput" type="text" placeholder="Input command..." 
                class="w-full bg-black/40 text-white placeholder-slate-600 p-4 rounded-2xl outline-none focus:ring-1 focus:ring-purple-500 mb-4">
            <div class="grid grid-cols-3 gap-2">
                <button onclick="togglePriority()" class="py-3 rounded-xl text-xs font-bold transition-all active:scale-95" style="background: var(--primary)">Ôºã TASK</button>
                <button onclick="addItem('idea')" class="py-3 rounded-xl text-xs font-bold opacity-80" style="background: var(--surface); border: 1px solid var(--primary)">IDEA</button>
                <button onclick="addItem('buy')" class="py-3 rounded-xl text-xs font-bold opacity-80" style="background: var(--surface); border: 1px solid var(--primary)">BUY</button>
            </div>
            <div id="priorityGroup" class="hidden grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-white/5">
                <button onclick="addTodo(1)" class="py-2 rounded-lg text-[10px] font-bold border border-red-500/50 text-red-400">CRITICAL</button>
                <button onclick="addTodo(2)" class="py-2 rounded-lg text-[10px] font-bold border border-yellow-500/50 text-yellow-400">NORMAL</button>
                <button onclick="addTodo(3)" class="py-2 rounded-lg text-[10px] font-bold border border-green-500/50 text-green-400">LOW</button>
            </div>
        </div>

        <main class="space-y-8">
            <section>
                <div class="flex justify-between items-center mb-3 px-2">
                    <h2 class="text-[10px] font-bold tracking-widest uppercase" style="color: var(--accent-blue)">üìù To-Do / Priority</h2>
                    <button onclick="clearCompleted('todo')" class="text-[10px] opacity-50 hover:opacity-100">CLEAN DONE</button>
                </div>
                <ul id="todoList" class="space-y-2"></ul>
            </section>
            <section>
                <h2 class="text-[10px] font-bold tracking-widest uppercase mb-3 px-2" style="color: var(--accent-pink)">üí° Brainstorm</h2>
                <ul id="ideaList" class="space-y-2"></ul>
            </section>
            <section>
                <h2 class="text-[10px] font-bold tracking-widest uppercase mb-3 px-2" style="color: var(--accent-yellow)">üõí Shopping</h2>
                <ul id="buyList" class="space-y-2"></ul>
            </section>
        </main>
    </div>

    <script>
        const CONFIG = {
            // ÂÆâÂÖ®ËÄÉÈáèÔºöToken ‰∏çÂØ´Ê≠ªÂú®‰ª£Á¢º‰∏≠ÔºåËÄåÊòØÂæû localStorage ÊäìÂèñ
            GIST_ID: '5b496142f75dec55cde88dd207f658a7',
            LYRICS_URL: 'https://raw.githubusercontent.com/mistyflow66/yc-daily/refs/heads/main/lyrics.json'
        };

        let db = { todo: [], idea: [], buy: [] };
        let lyricsDB = [];
        let currentLyric = null;

        // Ê†∏ÂøÉÔºöÁç≤Âèñ Token ÈÇèËºØ
        function getToken() {
            let token = localStorage.getItem('GIST_TOKEN');
            if (!token) {
                token = prompt("Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ GitHub Personal Access Token (ghp_...):\n(Ê≠§‰ª£Á¢ºÂÉÖÂ≠òÊñºÊÇ®ÁöÑÁÄèË¶ΩÂô®Âø´Âèñ‰∏≠Ôºå‰∏çÊúÉ‰∏äÂÇ≥Ëá≥ Repo)");
                if (token) localStorage.setItem('GIST_TOKEN', token);
            }
            return token;
        }

        function resetToken() {
            localStorage.removeItem('GIST_TOKEN');
            location.reload();
        }

        // ÂàùÂßãÂåñ
        async function init() {
            updateStatus('Checking Token...');
            const token = getToken();
            if (!token) {
                updateStatus('Need Token');
                return;
            }

            try {
                // 1. ÊäìÊ≠åË©û (ÈÄô‰∏çÈúÄË¶Å TokenÔºåÂõ†ÁÇ∫ Repo ÊòØÂÖ¨ÈñãÁöÑ)
                const lyricRes = await fetch(CONFIG.LYRICS_URL);
                lyricsDB = await lyricRes.json();
                
                // 2. ÊäìÂæÖËæ¶ (‰ΩøÁî®ÊâãÂãïËº∏ÂÖ•ÁöÑ Token)
                const gistRes = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
                    headers: { Authorization: `token ${token}` }
                });
                
                if (gistRes.status === 401) {
                    alert("Token ÁÑ°ÊïàÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•„ÄÇ");
                    resetToken();
                }

                const gistData = await gistRes.json();
                db = JSON.parse(gistData.files['dashboard.json'].content);
                
                renderAll();
                refreshLyric();
                updateStatus('System Online');
            } catch (e) {
                updateStatus('Sync Error');
                console.error(e);
            }
        }

        async function syncCloud() {
            const token = getToken();
            updateStatus('Syncing...');
            await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
                method: 'PATCH',
                headers: { Authorization: `token ${token}` },
                body: JSON.stringify({
                    files: { 'dashboard.json': { content: JSON.stringify(db) } }
                })
            });
            updateStatus('System Online');
        }

        function renderList(type) {
            const list = document.getElementById(type + 'List');
            const items = db[type] || [];
            const colors = { 1: 'var(--secondary)', 2: 'var(--accent-yellow)', 3: 'var(--accent-green)' };
            
            list.innerHTML = items.map(item => `
                <li class="surface p-4 rounded-2xl flex justify-between items-center group animate-in fade-in duration-500">
                    <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleDone('${type}', ${item.id})">
                        <div class="w-2 h-2 rounded-full" style="background: ${type==='todo' ? colors[item.level] : 'var(--primary)'}; box-shadow: 0 0 10px ${type==='todo' ? colors[item.level] : 'var(--primary)'}66"></div>
                        <span class="text-sm ${item.done ? 'done-text' : ''}">${item.text}</span>
                    </div>
                    <button onclick="deleteItem('${type}', ${item.id})" class="opacity-0 group-hover:opacity-100 text-xs text-slate-500">‚úï</button>
                </li>
            `).join('');
        }

        function refreshLyric() {
            if (!lyricsDB.length) return;
            currentLyric = lyricsDB[Math.floor(Math.random() * lyricsDB.length)];
            document.getElementById('lyric-content').innerHTML = `
                <div class="font-serif-tc text-lg mb-3 italic" style="color: var(--text)">„Äå${currentLyric.quote}„Äç</div>
                <div class="flex justify-between items-center">
                    <span class="text-[10px] uppercase tracking-widest" style="color: var(--text-muted)">// ${currentLyric.title}</span>
                    <button onclick="toggleVideo()" class="text-[10px] font-bold hover:underline" style="color: var(--accent-green)">DISPLAY_FULL</button>
                </div>
            `;
            document.getElementById('video-container').classList.add('hidden');
        }

        function toggleVideo() {
            const v = document.getElementById('video-container');
            if (v.classList.contains('hidden')) {
                v.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${currentLyric.ytId}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                v.classList.remove('hidden');
            } else { v.classList.add('hidden'); v.innerHTML = ''; }
        }

        function togglePriority() { document.getElementById('priorityGroup').classList.toggle('hidden'); }
        async function addTodo(level) {
            const text = document.getElementById('mainInput').value;
            if(!text) return;
            db.todo.push({ id: Date.now(), text, level, done: false });
            db.todo.sort((a,b) => a.level - b.level);
            await finalizeAction();
        }
        async function addItem(type) {
            const text = document.getElementById('mainInput').value;
            if(!text) return;
            db[type].push({ id: Date.now(), text, done: false });
            await finalizeAction();
        }
        async function toggleDone(type, id) {
            db[type] = db[type].map(i => i.id === id ? {...i, done: !i.done} : i);
            renderList(type);
            await syncCloud();
        }
        async function deleteItem(type, id) {
            db[type] = db[type].filter(i => i.id !== id);
            renderAll();
            await syncCloud();
        }
        async function clearCompleted(type) {
            db[type] = db[type].filter(i => !i.done);
            renderAll();
            await syncCloud();
        }
        async function finalizeAction() {
            document.getElementById('mainInput').value = '';
            document.getElementById('priorityGroup').classList.add('hidden');
            renderAll();
            refreshLyric();
            await syncCloud();
        }
        function renderAll() { ['todo', 'idea', 'buy'].forEach(renderList); }
        function updateStatus(txt) { document.getElementById('status').innerText = txt; }

        init();
    </script>
</body>
</html>
